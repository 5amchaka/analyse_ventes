# -------------------------------------------------------------------
# üê≥ Image finale minimaliste et s√©curis√©e
# -------------------------------------------------------------------
    FROM alpine:3.19

    # üìã Metadata
    LABEL description="Service d'ex√©cution des scripts d'analyse de ventes"
    LABEL version="2.0"

    # -------------------------------------------------------------------
    # üì¶ D√©pendances strictement n√©cessaires
    # -------------------------------------------------------------------
    RUN apk update && \
        apk add --no-cache \
            bash \
            sqlite \
            curl \
            ncurses \
            gettext \
            tini && \
        rm -rf /var/cache/apk/*
    
    # -------------------------------------------------------------------
    # üë§ Cr√©ation utilisateur non-root (configurable)
    # -------------------------------------------------------------------
    ARG USER_ID=1000
    ARG GROUP_ID=1000
    RUN addgroup -g ${GROUP_ID} appgroup && \
        adduser -D -u ${USER_ID} -G appgroup appuser
    
    # -------------------------------------------------------------------
    # üìÅ Structure des r√©pertoires
    # -------------------------------------------------------------------
    WORKDIR /app
    RUN mkdir -p /app/{data,results,database,scripts,sql} && \
        mkdir -p /app/tmp/sql_imports && \
        chown -R appuser:appgroup /app && \
        chown -R appuser:appgroup /app/tmp && \
        chmod -R 755 /app/tmp && \
        chmod -R 770 /app/tmp/sql_imports
    
    # -------------------------------------------------------------------
    # üìÇ Copie des fichiers (directe depuis le host)
    # -------------------------------------------------------------------
    COPY --chown=appuser:appgroup services/script-executor/scripts/ /app/scripts/
    COPY --chown=appuser:appgroup init-scripts/init-db.sh /app/scripts/
    COPY --chown=appuser:appgroup sql/ /app/sql/
    COPY --chown=appuser:appgroup .env /app/.env
    
    # -------------------------------------------------------------------
    # üîê Permissions
    # -------------------------------------------------------------------
    RUN find /app/scripts -type f -name "*.sh" -exec chmod +x {} \;
        
    # -------------------------------------------------------------------
    # ÔøΩ Configuration runtime
    # -------------------------------------------------------------------
    VOLUME ["/app/database", "/app/data", "/app/results"]
    USER appuser
    ENTRYPOINT ["/sbin/tini", "--"]
    CMD ["/bin/bash", "/app/scripts/run-pipeline.sh"]