# -------------------------------------------------------------------
# üê≥ Image finale minimaliste et s√©curis√©e
# -------------------------------------------------------------------
    FROM alpine:3.19

    # üìã Metadata
    LABEL maintainer="Votre√âquipe"
    LABEL description="Service d'ex√©cution des scripts d'analyse de ventes"
    LABEL version="1.0"

    # -------------------------------------------------------------------
    # üì¶ D√©pendances strictement n√©cessaires
    # -------------------------------------------------------------------
    RUN apk update && \
        apk add --no-cache \
            bash \
            sqlite \
            curl \
            ncurses \
            gettext \
            tini && \
        rm -rf /var/cache/apk/*
    
    # -------------------------------------------------------------------
    # üë§ Cr√©ation utilisateur non-root (configurable)
    # -------------------------------------------------------------------
    ARG USER_ID=1001
    ARG GROUP_ID=1001
    RUN addgroup -g ${GROUP_ID} appgroup && \
        adduser -D -u ${USER_ID} -G appgroup appuser
    
    # -------------------------------------------------------------------
    # üìÅ Structure des r√©pertoires
    # -------------------------------------------------------------------
    WORKDIR /app
    RUN mkdir -p /app/{data,results,database,scripts} && \
        chown -R appuser:appgroup /app
    
    # -------------------------------------------------------------------
    # üìÇ Copie des fichiers (directe depuis le host)
    # -------------------------------------------------------------------
    COPY --chown=appuser:appgroup services/script-executor/scripts/ /app/scripts/
    COPY --chown=appuser:appgroup init-scripts/ /app/scripts/
    COPY --chown=appuser:appgroup sql/ /app/scripts/
    COPY --chown=appuser:appgroup services/script-executor/scripts/env-loader.sh /app/
    
    # -------------------------------------------------------------------
    # üîê Permissions
    # -------------------------------------------------------------------
    RUN chmod +x /app/env-loader.sh && \
        find /app/scripts -type f -name "*.sh" -exec chmod +x {} \;
    
    # -------------------------------------------------------------------
    # ü©π Healthcheck
    # -------------------------------------------------------------------
    HEALTHCHECK --interval=30s --timeout=3s \
      CMD pgrep -f start-service.sh || exit 1
    
    # -------------------------------------------------------------------
    # üì° Configuration runtime
    # -------------------------------------------------------------------
    VOLUME ["/app/database", "/app/data", "/app/results"]
    EXPOSE 8080
    USER appuser
    ENTRYPOINT ["/sbin/tini", "--"]
    CMD ["/app/scripts/start-service.sh"]