# -------------------------------------------------------------------
# ğŸ³ Image finale minimaliste et sÃ©curisÃ©e
# -------------------------------------------------------------------
    FROM alpine:3.19

    # ğŸ“‹ Metadata
    LABEL maintainer="VotreÃ‰quipe"
    LABEL description="Service d'exÃ©cution des scripts d'analyse de ventes"
    LABEL version="1.0"
    
    # ğŸ“¦ DÃ©pendances strictement nÃ©cessaires
    RUN apk update && \
        apk add --no-cache \
            bash \
            sqlite \
            curl \
            ncurses \
            tini && \
        rm -rf /var/cache/apk/*
    
    # ğŸ‘¤ CrÃ©ation utilisateur non-root (configurable)
    ARG USER_ID=1001
    ARG GROUP_ID=1001
    RUN addgroup -g ${GROUP_ID} appgroup && \
        adduser -D -u ${USER_ID} -G appgroup appuser
    
    # ğŸ“ Structure des rÃ©pertoires
    WORKDIR /app
    RUN mkdir -p /app/{data,results,database,scripts} && \
        chown -R appuser:appgroup /app
    
    # ğŸ“‚ Copie des fichiers (directe depuis le host)
    COPY --chown=appuser:appgroup services/script-executor/scripts/ /app/scripts/
    COPY --chown=appuser:appgroup init-scripts/ /app/scripts/
    COPY --chown=appuser:appgroup sql/ /app/scripts/
    COPY --chown=appuser:appgroup services/script-executor/scripts/env-loader.sh /app/
    
    # ğŸ” Permissions
    RUN chmod +x /app/env-loader.sh && \
        find /app/scripts -type f -name "*.sh" -exec chmod +x {} \;
    
    # ğŸ©¹ Healthcheck
    HEALTHCHECK --interval=30s --timeout=3s \
      CMD pgrep -f start-service.sh || exit 1
    
    # ğŸ“¡ Configuration runtime
    VOLUME ["/app/database", "/app/data", "/app/results"]
    EXPOSE 8080
    USER appuser
    ENTRYPOINT ["/sbin/tini", "--"]
    CMD ["/app/scripts/start-service.sh"]