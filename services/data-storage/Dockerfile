# -------------------------------------------------------------------
# üóÑÔ∏è Service de stockage de donn√©es SQLite (Version s√©curis√©e)
# -------------------------------------------------------------------
  FROM alpine:3.19

  # -------------------------------------------------------------------
  # üì¶ Installation des d√©pendances minimales
  # -------------------------------------------------------------------
  RUN apk update && \
      apk add --no-cache \
          sqlite \
          tini && \
      rm -rf /var/cache/apk/*
  
  # -------------------------------------------------------------------
  # üë§ Cr√©ation de l'utilisateur non-root
  # -------------------------------------------------------------------
  ARG USER_ID=1000
  ARG GROUP_ID=1000
  
  RUN addgroup -g ${GROUP_ID} dbgroup && \
      adduser -D -u ${USER_ID} -G dbgroup dbuser
  
  # -------------------------------------------------------------------
  # üìÅ Configuration de l'environnement
  # -------------------------------------------------------------------
  WORKDIR /app
  
  # Cr√©ation des r√©pertoires avec permissions s√©curis√©es
  RUN mkdir -p /app/database && \
      chown -R dbuser:dbgroup /app && \
      chmod 755 /app && \
      chmod 700 /app/database  # S√©curit√© renforc√©e pour le volume
  
  # -------------------------------------------------------------------
  # üìÇ Copie des fichiers
  # -------------------------------------------------------------------
  COPY --chown=dbuser:dbgroup services/data-storage/entrypoint.sh /entrypoint.sh
  RUN chmod 750 /entrypoint.sh  # rx pour l'utilisateur, aucun droit pour les autres
  
  # -------------------------------------------------------------------
  # üóÉÔ∏è Configuration des volumes
  # -------------------------------------------------------------------
  VOLUME /app/database
  
  # -------------------------------------------------------------------
  # üöÄ Configuration runtime
  # -------------------------------------------------------------------
  USER dbuser
  ENTRYPOINT ["/sbin/tini", "--", "/entrypoint.sh"]